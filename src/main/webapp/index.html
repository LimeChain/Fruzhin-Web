<!DOCTYPE html>
<html>
<head>
    <title>Fruzhin</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <script type="module" src="js/fruzhin.js"></script>
</head>
<body>
<script>
    var libp = undefined;

    var getPeerId = () => {
        return libp?.peerId;
    }

    var start = async (bootnodes) => {
        console.log('Starting libp2p node');
        console.log(bootnodes);
        let test = {
            addresses: {
                listen: [],
            },
            transports: [
                Libp2PWebsockets.webSockets()
            ],
            streamMuxers: [ChainsafeLibp2PYamux.yamux()],
            connectionEncryption: [ChainsafeLibp2PNoise.noise()],
            peerDiscovery: [
                Libp2PBootstrap.bootstrap({
                    list: bootnodes
                })
            ],
            services: {
                identify: Libp2PIdentify.identify(),
                ping: Libp2PPing.ping(),
                dht: Libp2PKadDht.kadDHT({protocol: "/dot/kad"}),
                pubsub: ChainsafeLibp2PGossipsub.gossipsub(),
            }
        };

        libp = await Libp2P.createLibp2p(test);
        libp.start();

        // libp.addEventListener('peer:discovery', (evt) => console.log('Discovered:', evt.detail.id.toString()))
        // libp.addEventListener('peer:connect', (evt) => console.log('Connected:', evt.detail.toString()))
        // libp.addEventListener('peer:disconnect', (evt) => console.log('Disconnected:', evt.detail.toString()))

        // let pbStream = ItProtobufStream.pbStream;
        //
        // libp.handle('/dot/sync/warp', ({stream}) => {
        //
        //     console.log('Received a warp sync request');
        //     stream.write('Hello from the other side');
        //     stream.end();
        // });
    }
    main();
</script>
</body>
</html>